<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico - Supabase</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            font-weight: 600;
        }
        .status.ok {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.pending {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        code {
            background: #f0f0f0;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: monospace;
        }
        .console {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 20px;
        }
        button:hover {
            background: #5568d3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico - Supabase</h1>
        
        <div id="results"></div>
        
        <button onclick="runDiagnostics()">‚ñ∂ Ejecutar Diagn√≥stico</button>
    </div>

    <!-- Supabase Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        let logMessages = [];

        function log(message, type = 'log') {
            console.log(message);
            logMessages.push({
                message: message,
                type: type,
                time: new Date().toLocaleTimeString()
            });
        }

        function displayResults() {
            const resultsDiv = document.getElementById('results');
            let html = '<div class="console">';
            
            logMessages.forEach(msg => {
                let color = '#d4d4d4';
                if (msg.type === 'error') color = '#f48771';
                if (msg.type === 'success') color = '#6a9955';
                if (msg.type === 'warning') color = '#d7ba7d';
                
                html += `<div style="color: ${color};">[${msg.time}] ${msg.message}</div>`;
            });
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        async function runDiagnostics() {
            logMessages = [];
            
            log('=== INICIANDO DIAGN√ìSTICO ===', 'info');
            
            // 1. Verificar librer√≠a Supabase
            log('\n1. Verificando librer√≠a Supabase...');
            if (typeof supabase !== 'undefined') {
                log('‚úì Librer√≠a Supabase cargada correctamente', 'success');
            } else {
                log('‚úó Error: Librer√≠a Supabase NO est√° cargada', 'error');
                displayResults();
                return;
            }

            // 2. Verificar credenciales
            log('\n2. Verificando credenciales...');
            const SUPABASE_URL = 'https://wzfhosbyokruukbaboct.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6Zmhvc2J5b2tydXVrYmFib2N0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNjgzOTUsImV4cCI6MjA3OTk0NDM5NX0.OWUWzyPDrSJfkB0WUo2gjIsG6TEhPL578Ya_Z8o_PH0';
            
            if (SUPABASE_URL && SUPABASE_ANON_KEY) {
                log('‚úì Credenciales configuradas', 'success');
                log(`  URL: ${SUPABASE_URL}`);
                log(`  Key: ${SUPABASE_ANON_KEY.substring(0, 20)}...`);
            }

            // 3. Crear cliente
            log('\n3. Creando cliente Supabase...');
            try {
                const testClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                log('‚úì Cliente creado exitosamente', 'success');
                window.testClient = testClient;
            } catch (error) {
                log(`‚úó Error al crear cliente: ${error.message}`, 'error');
                displayResults();
                return;
            }

            // 4. Verificar conexi√≥n a BD
            log('\n4. Verificando conexi√≥n a la base de datos...');
            try {
                const { data, error } = await window.testClient
                    .from('users')
                    .select('count')
                    .limit(1);

                if (error) {
                    log(`‚úó Error de conexi√≥n: ${error.message}`, 'error');
                } else {
                    log('‚úì Conexi√≥n a BD establecida correctamente', 'success');
                    log('  BD responde correctamente');
                }
            } catch (error) {
                log(`‚úó Error al conectar: ${error.message}`, 'error');
                displayResults();
                return;
            }

            // 5. Intentar listar usuarios
            log('\n5. Intentando listar usuarios...');
            try {
                const { data: users, error } = await window.testClient
                    .from('users')
                    .select('*')
                    .limit(5);

                if (error) {
                    log(`‚úó Error: ${error.message}`, 'error');
                } else {
                    log(`‚úì Se encontraron ${users.length} usuarios`, 'success');
                    users.forEach(user => {
                        log(`  - ${user.email} (${user.role})`);
                    });
                }
            } catch (error) {
                log(`‚úó Error: ${error.message}`, 'error');
            }

            // 6. Verificar Auth
            log('\n6. Verificando Supabase Auth...');
            try {
                const { data: { session }, error } = await window.testClient.auth.getSession();
                
                if (error) {
                    log(`‚úó Error: ${error.message}`, 'error');
                } else if (session) {
                    log('‚úì Usuario autenticado', 'success');
                    log(`  Email: ${session.user.email}`);
                } else {
                    log('‚Ñπ No hay usuario autenticado (es normal)', 'warning');
                }
            } catch (error) {
                log(`‚úó Error: ${error.message}`, 'error');
            }

            log('\n=== DIAGN√ìSTICO COMPLETADO ===', 'info');
            log('\n‚úì Sistema est√° funcionando correctamente', 'success');
            log('Puedes proceder a usar los formularios', 'success');

            displayResults();
        }

        // Auto-run on load
        window.addEventListener('load', runDiagnostics);
    </script>
</body>
</html>
